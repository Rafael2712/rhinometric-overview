#!/usr/bin/env bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#  RHINOMETRIC v2.1.0 - ONE-COMMAND INSTALLER (Linux/macOS)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo " ๐ฆ RHINOMETRIC v2.1.0 - Enterprise Observability Platform"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. VALIDATE PREREQUISITES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [1/5] Validando prerequisitos..."

if ! command -v docker &> /dev/null; then
    echo "โ ERROR: Docker no estรก instalado"
    echo "   Instala Docker Desktop desde: https://docker.com/get-started"
    exit 1
fi

if ! command -v docker compose &> /dev/null; then
    echo "โ ERROR: Docker Compose no estรก disponible"
    echo "   Actualiza Docker a versiรณn 24.0+ que incluye Compose v2"
    exit 1
fi

DOCKER_VERSION=$(docker --version | grep -oP '\d+\.\d+' | head -1)
echo "   โ Docker ${DOCKER_VERSION} detectado"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. SETUP ENVIRONMENT
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โ๏ธ  [2/5] Configurando entorno..."

if [ ! -f .env ]; then
    if [ -f .env.example ]; then
        cp .env.example .env
        echo "   โ Archivo .env creado desde .env.example"
        echo "   โ๏ธ  IMPORTANTE: Edita .env y configura tus credenciales"
        echo ""
        read -p "   Presiona Enter para continuar con valores por defecto o Ctrl+C para editar primero..."
    else
        echo "   โ ERROR: No se encontrรณ .env.example"
        exit 1
    fi
else
    echo "   โ Archivo .env existente (no se sobrescribe)"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. CREATE DATA DIRECTORIES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ [3/5] Creando directorios de datos..."

DATA_DIR="${HOME}/rhinometric_data_v2.1"
mkdir -p "${DATA_DIR}"/{grafana,prometheus,loki,tempo,postgres,redis,license-server}

echo "   โ Directorios creados en: ${DATA_DIR}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 4. START SERVICES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ [4/5] Iniciando servicios Docker..."

cd deploy
docker compose -f docker-compose.yml up -d

echo "   โ Contenedores iniciados"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 5. VERIFY INSTALLATION
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "๐ [5/5] Verificando instalaciรณn..."
sleep 10

RUNNING_CONTAINERS=$(docker ps --format '{{.Names}}' | grep rhinometric | wc -l)
echo "   โ Contenedores activos: ${RUNNING_CONTAINERS}"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SUCCESS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo " โ INSTALACIรN COMPLETADA"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ACCESOS:"
echo "   โข Grafana:        http://localhost:3000"
echo "   โข Prometheus:     http://localhost:9090"
echo "   โข Loki:           http://localhost:3100"
echo "   โข License Server: http://localhost:5000"
echo "   โข License UI:     http://localhost:8092"
echo ""
echo "๐ CREDENCIALES GRAFANA:"
echo "   Usuario:    $(grep GF_SECURITY_ADMIN_USER .env | cut -d'=' -f2 || echo 'admin')"
echo "   Contraseรฑa: $(grep GF_SECURITY_ADMIN_PASSWORD .env | cut -d'=' -f2 || echo 'Ver archivo .env')"
echo ""
echo "๐ DOCUMENTACIรN: https://github.com/Rafael2712/rhinometric-overview"
echo "๐ฌ SOPORTE: rafael.canelon@rhinometric.com"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
